<!DOCTYPE html>
<html lang="{{ passenger.preferredLanguage }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Flight {{ flight.flightNumber }} | Rassid</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/tracker.css' %}">
</head>

<body>

    <div class="container">
        <div class="header-nav">
            <a href="/" class="back-btn">← Back to Home</a>
        </div>

        <div class="page-title">Passenger Tracking</div>

        <div class="card">
            <div class="flight-number">Flight Number: {{ flight.flightNumber }}</div>
            <div class="flight-header">
                <div class="flight-route">
                    {{ flight.origin.code }} <span style="color:var(--text-light)">→</span> {{ flight.destination.code
                    }}
                </div>
                <div class="status-badge status-{{ flight.status|lower }}">
                    Status: {{ flight.status }}
                </div>
            </div>
        </div>

        <div class="card">
            <div class="page-title" style="margin-bottom: 1rem; font-size: 1rem;">Gate Information</div>
            <div class="gate-grid">
                <div class="gate-item">
                    <label>Gate</label>
                    <div class="value">{{ gate.gateCode|default:"--" }}</div>
                </div>
                <div class="gate-item">
                    <label>Terminal</label>
                    <div class="value">{{ gate.terminal|default:"--" }}</div>
                </div>
                <div class="gate-item">
                    <label>Boarding Open</label>
                    <div class="value">{{ gate.boardingOpenTime|date:"H:i"|default:"--" }}</div>
                </div>
                <div class="gate-item">
                    <label>Boarding Close</label>
                    <div class="value">{{ gate.boardingCloseTime|date:"H:i"|default:"--" }}</div>
                </div>
            </div>

            <div class="countdown-box" id="countdown">
                {% if phase == 'pre_open' %}
                Boarding opens in {{ formatted_open }}
                {% elif phase == 'boarding' %}
                Boarding closes in {{ formatted_close }}
                {% elif phase == 'closed' %}
                Boarding Closed
                {% else %}
                Gate info waiting...
                {% endif %}
            </div>
        </div>

        <div class="card timeline-section">
            <h3>Updates Timeline</h3>

            {% if not timeline %}
            <div style="color: var(--text-light); font-style: italic;">No updates yet.</div>
            {% endif %}

            {% for event in timeline %}
            <div class="timeline-item">
                <div class="timeline-time">{{ event.timestamp|date:"h:i A" }}</div>
                <div class="timeline-title">{{ event.title }}</div>
                <div class="timeline-desc">{{ event.description }}</div>
            </div>
            {% endfor %}

            <div class="timeline-item">
                <div class="timeline-time">{{ flight.scheduledDeparture|date:"h:i A" }} (Scheduled)</div>
                <div class="timeline-title">Flight Scheduled</div>
                <div class="timeline-desc">Flight {{ flight.flightNumber }} added to schedule.</div>
            </div>
        </div>

        <div style="text-align: left; margin-bottom: 2rem;">
            <button onclick="window.location.reload()" class="back-btn">Refresh</button>
        </div>

        <div class="card">
            <div class="map-placeholder">
                [Map Placeholder]
            </div>
            <button onclick="alert('Opening Maps...')" class="action-btn">Get Directions</button>
        </div>

    </div>

    <script>
        let phase = "{{ phase }}";
        let remainingSeconds = 0;

        if (phase === 'pre_open') {
            remainingSeconds = {{ seconds_to_open }
        };
        } else if (phase === 'boarding') {
            remainingSeconds = {{ seconds_to_close }
        };
        }

        function pad(n) { return n < 10 ? '0' + n : n; }

        function formatTime(totalSeconds) {
            if (totalSeconds < 0) return "00:00:00";
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;

            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        function updateCounter() {
            const el = document.getElementById("countdown");

            if (phase === 'closed') {
                el.innerHTML = "Boarding Closed";
                el.style.color = "#ef4444";
                return;
            }

            if (phase === 'unknown') return;

            remainingSeconds--;

            if (remainingSeconds < 0) {
                location.reload();
                return;
            }

            let prefix = "";
            let timeString = formatTime(remainingSeconds);

            if (phase === 'pre_open') {
                prefix = "Boarding opens in";
                el.style.color = "var(--primary)";
            } else if (phase === 'boarding') {
                prefix = "Boarding closes in";
                el.style.color = "#b45309";
            }

            el.innerHTML = `${prefix} ${timeString}`;
        }

        if (phase !== 'closed' && phase !== 'unknown') {
            setInterval(updateCounter, 1000);
            updateCounter();
        }
    </script>

</body>

</html>